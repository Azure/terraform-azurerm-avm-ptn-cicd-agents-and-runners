<!-- BEGIN_TF_DOCS -->
<!-- Code generated by terraform-docs. DO NOT EDIT. -->
# Azure DevOps Container Apps with UAMI authentication

This example deploys Azure DevOps Agents to Azure Container Apps using User Assigned Managed Identity (UAMI) authentication instead of PAT tokens. It includes automated UAMI creation and Azure DevOps project setup.

```hcl
locals {
  tags = {
    scenario = "container_app_uami_auth"
  }
}

terraform {
  required_version = ">= 1.9"

  required_providers {
    azuredevops = {
      source  = "microsoft/azuredevops"
      version = "~> 1.1"
    }
    azurerm = {
      source  = "hashicorp/azurerm"
      version = "~> 4.20"
    }
    random = {
      source  = "hashicorp/random"
      version = "~> 3.5"
    }
    time = {
      source  = "hashicorp/time"
      version = "~> 0.9"
    }
  }
}

provider "azurerm" {
  features {}
}

locals {
  azure_devops_organization_url = "https://dev.azure.com/${var.azure_devops_organization_name}"
}

# Azure DevOps provider - uses Azure CLI for local development
provider "azuredevops" {
  personal_access_token = var.azure_devops_personal_access_token
  org_service_url       = local.azure_devops_organization_url
}

resource "random_string" "name" {
  length  = 6
  numeric = true
  special = false
  upper   = false
}

module "naming" {
  source  = "Azure/naming/azurerm"
  version = "0.4.2"
}

data "azurerm_client_config" "this" {}

# ========================================
# PHASE 1: PREREQUISITES
# ========================================
# This section creates the UAMI and Azure DevOps resources

# Create UAMI for agent authentication
module "uami" {
  source  = "Azure/avm-res-managedidentity-userassignedidentity/azurerm"
  version = "0.3.3"

  location            = local.selected_region
  name                = "uami-devops-agents-${random_string.name.result}"
  resource_group_name = azurerm_resource_group.this.name
  enable_telemetry    = true
  tags                = local.tags
}

# ========================================
# Azure Resources
# ========================================

# Create Resource Group for our infrastructure
resource "azurerm_resource_group" "this" {
  location = local.selected_region
  name     = "${module.naming.resource_group.name_unique}-${random_string.name.result}"
  tags     = local.tags
}

# Grant necessary Azure permissions to the UAMI
resource "azurerm_role_assignment" "uami_contributor" {
  principal_id         = module.uami.principal_id
  scope                = azurerm_resource_group.this.id
  role_definition_name = "Contributor"
}

resource "azurerm_role_assignment" "uami_acr_push" {
  principal_id         = module.uami.principal_id
  scope                = "/subscriptions/${data.azurerm_client_config.this.subscription_id}"
  role_definition_name = "AcrPush"
}

# Azure DevOps Project
resource "azuredevops_project" "this" {
  name        = "cicd-agents-${random_string.name.result}"
  description = "CI/CD Container App Agents Project"

  features = {
    "artifacts"    = "enabled"
    "boards"       = "disabled"
    "pipelines"    = "enabled"
    "repositories" = "enabled"
    "testplans"    = "disabled"
  }
}

# Azure DevOps Agent Pool
resource "azuredevops_agent_pool" "this" {
  name           = "ContainerApps-UAMI-${random_string.name.result}"
  auto_provision = false
  auto_update    = true
}

# Agent Queue (connects pool to project)
resource "azuredevops_agent_queue" "this" {
  project_id    = azuredevops_project.this.id
  agent_pool_id = azuredevops_agent_pool.this.id
}

# Service Connection for Azure access
resource "azuredevops_serviceendpoint_azurerm" "this" {
  project_id                             = azuredevops_project.this.id
  service_endpoint_name                  = "Azure-UAMI-${random_string.name.result}"
  description                            = "Service connection using UAMI authentication"
  service_endpoint_authentication_scheme = "ManagedServiceIdentity"

  credentials {
    serviceprincipalid = module.uami.client_id
  }

  azurerm_spn_tenantid      = data.azurerm_client_config.this.tenant_id
  azurerm_subscription_id   = data.azurerm_client_config.this.subscription_id
  azurerm_subscription_name = "Primary Subscription"
}

# Basic repository and pipeline
resource "azuredevops_git_repository" "this" {
  project_id     = azuredevops_project.this.id
  name           = "cicd-agents-repo"
  default_branch = "refs/heads/main"

  initialization {
    init_type = "Clean"
  }
}

# Upload the pipeline YAML file to the repository with actual values
resource "azuredevops_git_repository_file" "pipeline" {
  repository_id = azuredevops_git_repository.this.id
  file          = "azure-pipelines.yml"
  content = templatefile("${path.module}/pipeline.yml", {
    agent_pool_name         = azuredevops_agent_pool.this.name
    service_connection_name = azuredevops_serviceendpoint_azurerm.this.service_endpoint_name
    resource_group_name     = azurerm_resource_group.this.name
  })
  branch              = "refs/heads/main"
  commit_message      = "Add KEDA auto-scaling test pipeline with UAMI authentication"
  overwrite_on_create = true

  depends_on = [azuredevops_git_repository.this]
}

# Create the Azure DevOps pipeline based on the uploaded YAML file
resource "azuredevops_build_definition" "this" {
  project_id = azuredevops_project.this.id
  name       = "KEDA Auto-Scaling Test Pipeline"
  path       = "\\"

  ci_trigger {
    use_yaml = true
  }

  repository {
    repo_type   = "TfsGit"
    repo_id     = azuredevops_git_repository.this.id
    branch_name = azuredevops_git_repository.this.default_branch
    yml_path    = "azure-pipelines.yml"
  }

  depends_on = [
    azuredevops_git_repository_file.pipeline,
    azuredevops_agent_queue.this
  ]
}

# Authorize the pipeline to use the agent queue
resource "azuredevops_pipeline_authorization" "this" {
  project_id  = azuredevops_project.this.id
  resource_id = azuredevops_agent_queue.this.id
  type        = "queue"
  pipeline_id = azuredevops_build_definition.this.id
}

# ========================================
# Azure DevOps Service Principal Setup
# ========================================
# Automated setup: Create service principal entitlement and add to required group

# Get the Project Collection Service Accounts group (organization-level)
data "azuredevops_group" "project_collection_service_accounts" {
  name = "Project Collection Service Accounts"
  # No project_id specified - searches at organization level
}

# Add a delay to ensure UAMI is fully propagated in Azure AD
resource "time_sleep" "uami_propagation" {
  create_duration = "30s" # Wait 30 seconds for UAMI to propagate

  depends_on = [module.uami]
}

# Create service principal entitlement for the UAMI
resource "azuredevops_service_principal_entitlement" "uami" {
  account_license_type = "express"                # Basic license required for service principals
  origin               = "aad"                    # Azure Active Directory
  origin_id            = module.uami.principal_id # Use principal_id (object ID) for managed identities

  depends_on = [
    time_sleep.uami_propagation
  ]
}

# Add UAMI service principal to Project Collection Service Accounts group
resource "azuredevops_group_membership" "uami_service_accounts" {
  group   = data.azuredevops_group.project_collection_service_accounts.descriptor
  members = [azuredevops_service_principal_entitlement.uami.descriptor]
  mode    = "add"

  depends_on = [
    azuredevops_service_principal_entitlement.uami,
    data.azuredevops_group.project_collection_service_accounts
  ]
}

# ========================================
# PHASE 2: INFRASTRUCTURE
# ========================================
# Simple AVM module call using the UAMI created above

module "azure_devops_agents" {
  source = "../.."

  # Basic Configuration
  location                                        = local.selected_region
  postfix                                         = random_string.name.result
  version_control_system_organization             = local.azure_devops_organization_url
  version_control_system_type                     = "azuredevops"
  compute_types                                   = ["azure_container_app"]
  container_app_max_execution_count               = 10
  container_app_min_execution_count               = 0
  container_app_polling_interval_seconds          = 30
  resource_group_creation_enabled                 = false
  resource_group_name                             = azurerm_resource_group.this.name
  tags                                            = local.tags
  use_private_networking                          = false
  user_assigned_managed_identity_client_id        = module.uami.client_id
  user_assigned_managed_identity_creation_enabled = false
  user_assigned_managed_identity_id               = module.uami.resource_id
  user_assigned_managed_identity_principal_id     = module.uami.principal_id
  version_control_system_authentication_method    = "uami"
  version_control_system_personal_access_token    = null # Clean: no PAT needed!
  version_control_system_pool_name                = azuredevops_agent_pool.this.name
  virtual_network_address_space                   = "10.0.0.0/16"

  depends_on = [
    azurerm_role_assignment.uami_contributor,
    azurerm_role_assignment.uami_acr_push,
    azuredevops_agent_queue.this,
    azuredevops_serviceendpoint_azurerm.this,
    azuredevops_group_membership.uami_service_accounts
  ]
}

# Region helpers
module "regions" {
  source  = "Azure/avm-utl-regions/azurerm"
  version = "0.3.0"
}

resource "random_integer" "region_index" {
  max = length(local.regions) - 1
  min = 0
}

locals {
  excluded_regions = [
    "westeurope" # Capacity issues
  ]
  included_regions = [
    "northcentralusstage", "westus2", "southeastasia", "swedencentral", "canadacentral", "westeurope", "northeurope", "eastus", "eastus2", "eastasia", "australiaeast", "germanywestcentral", "japaneast", "uksouth", "westus", "centralus", "northcentralus", "southcentralus", "koreacentral", "brazilsouth", "westus3", "francecentral", "southafricanorth", "norwayeast", "switzerlandnorth", "uaenorth", "canadaeast", "westcentralus", "ukwest", "centralindia", "italynorth", "polandcentral", "southindia"
  ]
  regions         = [for region in module.regions.regions : region.name if !contains(local.excluded_regions, region.name) && contains(local.included_regions, region.name)]
  selected_region = var.location_override != null ? var.location_override : local.regions[random_integer.region_index.result]
}
```

<!-- markdownlint-disable MD033 -->
## Requirements

The following requirements are needed by this module:

- <a name="requirement_terraform"></a> [terraform](#requirement\_terraform) (>= 1.9)

- <a name="requirement_azuredevops"></a> [azuredevops](#requirement\_azuredevops) (~> 1.1)

- <a name="requirement_azurerm"></a> [azurerm](#requirement\_azurerm) (~> 4.20)

- <a name="requirement_random"></a> [random](#requirement\_random) (~> 3.5)

- <a name="requirement_time"></a> [time](#requirement\_time) (~> 0.9)

## Resources

The following resources are used by this module:

- [azuredevops_agent_pool.this](https://registry.terraform.io/providers/microsoft/azuredevops/latest/docs/resources/agent_pool) (resource)
- [azuredevops_agent_queue.this](https://registry.terraform.io/providers/microsoft/azuredevops/latest/docs/resources/agent_queue) (resource)
- [azuredevops_build_definition.this](https://registry.terraform.io/providers/microsoft/azuredevops/latest/docs/resources/build_definition) (resource)
- [azuredevops_git_repository.this](https://registry.terraform.io/providers/microsoft/azuredevops/latest/docs/resources/git_repository) (resource)
- [azuredevops_git_repository_file.pipeline](https://registry.terraform.io/providers/microsoft/azuredevops/latest/docs/resources/git_repository_file) (resource)
- [azuredevops_group_membership.uami_service_accounts](https://registry.terraform.io/providers/microsoft/azuredevops/latest/docs/resources/group_membership) (resource)
- [azuredevops_pipeline_authorization.this](https://registry.terraform.io/providers/microsoft/azuredevops/latest/docs/resources/pipeline_authorization) (resource)
- [azuredevops_project.this](https://registry.terraform.io/providers/microsoft/azuredevops/latest/docs/resources/project) (resource)
- [azuredevops_service_principal_entitlement.uami](https://registry.terraform.io/providers/microsoft/azuredevops/latest/docs/resources/service_principal_entitlement) (resource)
- [azuredevops_serviceendpoint_azurerm.this](https://registry.terraform.io/providers/microsoft/azuredevops/latest/docs/resources/serviceendpoint_azurerm) (resource)
- [azurerm_resource_group.this](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/resource_group) (resource)
- [azurerm_role_assignment.uami_acr_push](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/role_assignment) (resource)
- [azurerm_role_assignment.uami_contributor](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/role_assignment) (resource)
- [random_integer.region_index](https://registry.terraform.io/providers/hashicorp/random/latest/docs/resources/integer) (resource)
- [random_string.name](https://registry.terraform.io/providers/hashicorp/random/latest/docs/resources/string) (resource)
- [time_sleep.uami_propagation](https://registry.terraform.io/providers/hashicorp/time/latest/docs/resources/sleep) (resource)
- [azuredevops_group.project_collection_service_accounts](https://registry.terraform.io/providers/microsoft/azuredevops/latest/docs/data-sources/group) (data source)
- [azurerm_client_config.this](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/data-sources/client_config) (data source)

<!-- markdownlint-disable MD013 -->
## Required Inputs

The following input variables are required:

### <a name="input_azure_devops_organization_name"></a> [azure\_devops\_organization\_name](#input\_azure\_devops\_organization\_name)

Description: Azure DevOps Organisation Name

Type: `string`

### <a name="input_azure_devops_personal_access_token"></a> [azure\_devops\_personal\_access\_token](#input\_azure\_devops\_personal\_access\_token)

Description: The personal access token used for agent authentication to Azure DevOps.

Type: `string`

## Optional Inputs

The following input variables are optional (have default values):

### <a name="input_location_override"></a> [location\_override](#input\_location\_override)

Description: (Optional) Override the automatically selected Azure region. If not specified, a region is chosen automatically.

Type: `string`

Default: `null`

## Outputs

The following outputs are exported:

### <a name="output_container_app_environment_name"></a> [container\_app\_environment\_name](#output\_container\_app\_environment\_name)

Description: n/a

### <a name="output_container_app_environment_resource_id"></a> [container\_app\_environment\_resource\_id](#output\_container\_app\_environment\_resource\_id)

Description: n/a

### <a name="output_container_app_job_name"></a> [container\_app\_job\_name](#output\_container\_app\_job\_name)

Description: n/a

### <a name="output_container_app_job_resource_id"></a> [container\_app\_job\_resource\_id](#output\_container\_app\_job\_resource\_id)

Description: n/a

### <a name="output_user_assigned_managed_identity_client_id"></a> [user\_assigned\_managed\_identity\_client\_id](#output\_user\_assigned\_managed\_identity\_client\_id)

Description: n/a

### <a name="output_user_assigned_managed_identity_resource_id"></a> [user\_assigned\_managed\_identity\_resource\_id](#output\_user\_assigned\_managed\_identity\_resource\_id)

Description: n/a

## Modules

The following Modules are called:

### <a name="module_azure_devops_agents"></a> [azure\_devops\_agents](#module\_azure\_devops\_agents)

Source: ../..

Version:

### <a name="module_naming"></a> [naming](#module\_naming)

Source: Azure/naming/azurerm

Version: 0.4.2

### <a name="module_regions"></a> [regions](#module\_regions)

Source: Azure/avm-utl-regions/azurerm

Version: 0.3.0

### <a name="module_uami"></a> [uami](#module\_uami)

Source: Azure/avm-res-managedidentity-userassignedidentity/azurerm

Version: 0.3.3

<!-- markdownlint-disable-next-line MD041 -->
## Data Collection

The software may collect information about you and your use of the software and send it to Microsoft. Microsoft may use this information to provide services and improve our products and services. You may turn off the telemetry as described in the repository. There are also some features in the software that may enable you and Microsoft to collect data from users of your applications. If you use these features, you must comply with applicable law, including providing appropriate notices to users of your applications together with a copy of Microsoftâ€™s privacy statement. Our privacy statement is located at <https://go.microsoft.com/fwlink/?LinkID=824704>. You can learn more about data collection and use in the help documentation and our privacy statement. Your use of the software operates as your consent to these practices.
<!-- END_TF_DOCS -->