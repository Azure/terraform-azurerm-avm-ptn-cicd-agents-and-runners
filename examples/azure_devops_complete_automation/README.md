<!-- BEGIN_TF_DOCS -->
<!-- Code generated by terraform-docs. DO NOT EDIT. -->
# Azure DevOps Complete Automation Example

This example demonstrates a **comprehensive end-to-end automation** for Azure DevOps CI/CD agents using:

- **External UAMI Creation** with proper Azure RBAC permissions
- **Azure DevOps Terraform Provider** for automated project, pool, and permissions setup
- **AVM Pattern Module** using external identity (recommended approach)
- **Complete UAMI Authentication** for both Azure resources and Azure DevOps API
- **Production-Ready Security** following least privilege principles

## Key Features

✅ **Zero Manual Setup** - Complete infrastructure and DevOps automation
✅ **UAMI Authentication** - No PAT tokens required, uses managed identity
✅ **External Identity** - UAMI created outside module (best practice)
✅ **Azure DevOps Provider** - Automated project, pool, and service connection creation
✅ **End-to-End Pipeline** - Working example with all permissions configured

## What Gets Created

### Azure Resources
- Resource Group with all infrastructure
- **External** User Assigned Managed Identity (UAMI)
- Container App Environment and Jobs
- Azure Container Registry
- Log Analytics Workspace
- Virtual Network with security

### Azure DevOps Resources
- DevOps Project with full configuration
- Agent Pool for Container Apps
- Agent Queue with proper permissions
- Service Connection using UAMI
- Git Repository with sample pipeline
- Build Definition with authorization

### RBAC and Permissions
- Azure: Contributor + AcrPush for UAMI
- DevOps: Service connection with UAMI authentication
- Pipeline: Authorized to use pool and service connection

```hcl
# ========================================
# Azure DevOps CI/CD Agents - Complete Setup Example
# ========================================
# This example demonstrates a complete setup in two phases:
# 1. Prerequisites: Creates UAMI and Azure DevOps resources
# 2. Infrastructure: Deploys Container Apps using the UAMI
#
# Clean separation: DevOps setup separate from infrastructure deployment

locals {
  azure_devops_organization_url = var.azure_devops_organization_url
  tags = {
    scenario    = "complete_azdo_setup"
    environment = var.environment
    purpose     = "cicd-agents"
  }
}

terraform {
  required_version = ">= 1.9"

  required_providers {
    azuredevops = {
      source  = "microsoft/azuredevops"
      version = "~> 1.1"
    }
    azurerm = {
      source  = "hashicorp/azurerm"
      version = "~> 4.20"
    }
    random = {
      source  = "hashicorp/random"
      version = "~> 3.5"
    }
    time = {
      source  = "hashicorp/time"
      version = "~> 0.9"
    }
  }
}

provider "azurerm" {
  features {}
}

# Azure DevOps provider - uses Azure CLI for local development
provider "azuredevops" {
  org_service_url = local.azure_devops_organization_url
  use_cli         = true # Simple: uses your 'az login' context
}

# ========================================
# Random Resources for Naming
# ========================================

resource "random_string" "name" {
  length  = 6
  numeric = true
  special = false
  upper   = false
}

module "naming" {
  source  = "Azure/naming/azurerm"
  version = ">= 0.3.0"
}

# ========================================
# Data Sources
# ========================================

data "azurerm_client_config" "this" {}

# ========================================
# PHASE 1: PREREQUISITES
# ========================================
# This section creates the UAMI and Azure DevOps resources

# Create UAMI for agent authentication
module "uami" {
  source  = "Azure/avm-res-managedidentity-userassignedidentity/azurerm"
  version = "0.3.3"

  location            = azurerm_resource_group.this.location
  name                = "uami-devops-agents-${random_string.name.result}"
  resource_group_name = azurerm_resource_group.this.name
  enable_telemetry    = true
  tags                = local.tags
}

# ========================================
# Azure Resources
# ========================================

# Create Resource Group for our infrastructure
resource "azurerm_resource_group" "this" {
  location = var.location
  name     = "${module.naming.resource_group.name_unique}-${random_string.name.result}"
  tags     = local.tags
}

# Grant necessary Azure permissions to the UAMI
resource "azurerm_role_assignment" "uami_contributor" {
  principal_id         = module.uami.principal_id
  scope                = azurerm_resource_group.this.id
  role_definition_name = "Contributor"

  depends_on = [module.uami]
}

resource "azurerm_role_assignment" "uami_acr_push" {
  principal_id         = module.uami.principal_id
  scope                = "/subscriptions/${data.azurerm_client_config.this.subscription_id}"
  role_definition_name = "AcrPush"

  depends_on = [module.uami]
}

# Azure DevOps Project
resource "azuredevops_project" "this" {
  name        = "cicd-agents-${random_string.name.result}"
  description = "CI/CD Container App Agents Project"

  features = {
    "artifacts"    = "enabled"
    "boards"       = "disabled"
    "pipelines"    = "enabled"
    "repositories" = "enabled"
    "testplans"    = "disabled"
  }
}

# Azure DevOps Agent Pool
resource "azuredevops_agent_pool" "this" {
  name           = "ContainerApps-${random_string.name.result}"
  auto_provision = false
  auto_update    = true
}

# Agent Queue (connects pool to project)
resource "azuredevops_agent_queue" "this" {
  project_id    = azuredevops_project.this.id
  agent_pool_id = azuredevops_agent_pool.this.id
}

# Service Connection for Azure access
resource "azuredevops_serviceendpoint_azurerm" "this" {
  project_id                             = azuredevops_project.this.id
  service_endpoint_name                  = "Azure-UAMI-${random_string.name.result}"
  description                            = "Service connection using UAMI authentication"
  service_endpoint_authentication_scheme = "ManagedServiceIdentity"

  credentials {
    serviceprincipalid = module.uami.client_id
  }

  azurerm_spn_tenantid      = data.azurerm_client_config.this.tenant_id
  azurerm_subscription_id   = data.azurerm_client_config.this.subscription_id
  azurerm_subscription_name = "Primary Subscription"
}

# Basic repository and pipeline
resource "azuredevops_git_repository" "this" {
  project_id     = azuredevops_project.this.id
  name           = "cicd-agents-repo"
  default_branch = "refs/heads/main"

  initialization {
    init_type = "Clean"
  }
}

# Upload the pipeline YAML file to the repository with actual values
resource "azuredevops_git_repository_file" "pipeline" {
  repository_id = azuredevops_git_repository.this.id
  file          = "azure-pipelines.yml"
  content = templatefile("${path.module}/pipeline.yml", {
    agent_pool_name         = azuredevops_agent_pool.this.name
    service_connection_name = azuredevops_serviceendpoint_azurerm.this.service_endpoint_name
    resource_group_name     = azurerm_resource_group.this.name
  })
  branch              = "refs/heads/main"
  commit_message      = "Add KEDA auto-scaling test pipeline with UAMI authentication"
  overwrite_on_create = true

  depends_on = [azuredevops_git_repository.this]
}

# Create the Azure DevOps pipeline based on the uploaded YAML file
resource "azuredevops_build_definition" "this" {
  project_id = azuredevops_project.this.id
  name       = "KEDA Auto-Scaling Test Pipeline"
  path       = "\\"

  ci_trigger {
    use_yaml = true
  }

  repository {
    repo_type   = "TfsGit"
    repo_id     = azuredevops_git_repository.this.id
    branch_name = azuredevops_git_repository.this.default_branch
    yml_path    = "azure-pipelines.yml"
  }

  depends_on = [
    azuredevops_git_repository_file.pipeline,
    azuredevops_agent_queue.this
  ]
}

# ========================================
# Azure DevOps Service Principal Setup
# ========================================
# Automated setup: Create service principal entitlement and add to required group

# Get the Project Collection Service Accounts group (organization-level)
data "azuredevops_group" "project_collection_service_accounts" {
  name = "Project Collection Service Accounts"
  # No project_id specified - searches at organization level
}

# Add a delay to ensure UAMI is fully propagated in Azure AD
resource "time_sleep" "uami_propagation" {
  create_duration = "30s" # Wait 30 seconds for UAMI to propagate

  depends_on = [module.uami]
}

# Create service principal entitlement for the UAMI
resource "azuredevops_service_principal_entitlement" "uami" {
  account_license_type = "express"                # Basic license required for service principals
  origin               = "aad"                    # Azure Active Directory
  origin_id            = module.uami.principal_id # Use principal_id (object ID) for managed identities

  depends_on = [
    module.uami,
    time_sleep.uami_propagation
  ]
}

# Add UAMI service principal to Project Collection Service Accounts group
resource "azuredevops_group_membership" "uami_service_accounts" {
  group   = data.azuredevops_group.project_collection_service_accounts.descriptor
  members = [azuredevops_service_principal_entitlement.uami.descriptor]
  mode    = "add"

  depends_on = [
    azuredevops_service_principal_entitlement.uami,
    data.azuredevops_group.project_collection_service_accounts
  ]
}

# ========================================
# PHASE 2: INFRASTRUCTURE
# ========================================
# Simple AVM module call using the UAMI created above

module "azure_devops_agents" {
  source = "../.."

  # Basic Configuration
  location                            = var.location
  postfix                             = random_string.name.result
  version_control_system_organization = local.azure_devops_organization_url
  # Version Control System Configuration - uses the resources created above
  version_control_system_type = "azuredevops"
  # Compute Configuration
  compute_types = var.compute_types
  # Container App Configuration
  container_app_max_execution_count      = 10
  container_app_min_execution_count      = 0
  container_app_polling_interval_seconds = 30
  default_image_repository_commit        = var.default_image_repository_commit
  # Use the Resource Group we created
  resource_group_creation_enabled          = false
  resource_group_name                      = azurerm_resource_group.this.name
  tags                                     = local.tags
  use_private_networking                   = var.use_private_networking
  user_assigned_managed_identity_client_id = module.uami.client_id
  # Use the UAMI created in Phase 1
  user_assigned_managed_identity_creation_enabled = false
  user_assigned_managed_identity_id               = module.uami.resource_id
  user_assigned_managed_identity_principal_id     = module.uami.principal_id
  version_control_system_authentication_method    = "uami"
  version_control_system_personal_access_token    = null # Clean: no PAT needed!
  version_control_system_pool_name                = azuredevops_agent_pool.this.name
  # Networking Configuration
  virtual_network_address_space = var.virtual_network_address_space

  # Clean dependencies - everything from Phase 1 including automated UAMI setup
  depends_on = [
    azurerm_role_assignment.uami_contributor,
    azurerm_role_assignment.uami_acr_push,
    azuredevops_agent_queue.this,
    azuredevops_serviceendpoint_azurerm.this,
    azuredevops_group_membership.uami_service_accounts
  ]
}
```

<!-- markdownlint-disable MD033 -->
## Requirements

The following requirements are needed by this module:

- <a name="requirement_terraform"></a> [terraform](#requirement\_terraform) (>= 1.9)

- <a name="requirement_azuredevops"></a> [azuredevops](#requirement\_azuredevops) (~> 1.1)

- <a name="requirement_azurerm"></a> [azurerm](#requirement\_azurerm) (~> 4.20)

- <a name="requirement_random"></a> [random](#requirement\_random) (~> 3.5)

- <a name="requirement_time"></a> [time](#requirement\_time) (~> 0.9)

## Resources

The following resources are used by this module:

- [azuredevops_agent_pool.this](https://registry.terraform.io/providers/microsoft/azuredevops/latest/docs/resources/agent_pool) (resource)
- [azuredevops_agent_queue.this](https://registry.terraform.io/providers/microsoft/azuredevops/latest/docs/resources/agent_queue) (resource)
- [azuredevops_build_definition.this](https://registry.terraform.io/providers/microsoft/azuredevops/latest/docs/resources/build_definition) (resource)
- [azuredevops_git_repository.this](https://registry.terraform.io/providers/microsoft/azuredevops/latest/docs/resources/git_repository) (resource)
- [azuredevops_git_repository_file.pipeline](https://registry.terraform.io/providers/microsoft/azuredevops/latest/docs/resources/git_repository_file) (resource)
- [azuredevops_group_membership.uami_service_accounts](https://registry.terraform.io/providers/microsoft/azuredevops/latest/docs/resources/group_membership) (resource)
- [azuredevops_project.this](https://registry.terraform.io/providers/microsoft/azuredevops/latest/docs/resources/project) (resource)
- [azuredevops_service_principal_entitlement.uami](https://registry.terraform.io/providers/microsoft/azuredevops/latest/docs/resources/service_principal_entitlement) (resource)
- [azuredevops_serviceendpoint_azurerm.this](https://registry.terraform.io/providers/microsoft/azuredevops/latest/docs/resources/serviceendpoint_azurerm) (resource)
- [azurerm_resource_group.this](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/resource_group) (resource)
- [azurerm_role_assignment.uami_acr_push](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/role_assignment) (resource)
- [azurerm_role_assignment.uami_contributor](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/role_assignment) (resource)
- [random_string.name](https://registry.terraform.io/providers/hashicorp/random/latest/docs/resources/string) (resource)
- [time_sleep.uami_propagation](https://registry.terraform.io/providers/hashicorp/time/latest/docs/resources/sleep) (resource)
- [azuredevops_group.project_collection_service_accounts](https://registry.terraform.io/providers/microsoft/azuredevops/latest/docs/data-sources/group) (data source)
- [azurerm_client_config.this](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/data-sources/client_config) (data source)

<!-- markdownlint-disable MD013 -->
## Required Inputs

The following input variables are required:

### <a name="input_azure_devops_organization_url"></a> [azure\_devops\_organization\_url](#input\_azure\_devops\_organization\_url)

Description: (Required) The full URL of your Azure DevOps organization. Example: https://dev.azure.com/myorg

Type: `string`

## Optional Inputs

The following input variables are optional (have default values):

### <a name="input_additional_tags"></a> [additional\_tags](#input\_additional\_tags)

Description: (Optional) Additional tags to apply to all resources.

Type: `map(string)`

Default: `{}`

### <a name="input_compute_types"></a> [compute\_types](#input\_compute\_types)

Description: (Optional) List of compute types to deploy. Valid options: 'azure\_container\_app', 'azure\_container\_instance'.

Type: `list(string)`

Default:

```json
[
  "azure_container_app"
]
```

### <a name="input_default_image_repository_commit"></a> [default\_image\_repository\_commit](#input\_default\_image\_repository\_commit)

Description: The default image repository commit to use if no custom image is provided.

Type: `string`

Default: `"bc4087f"`

### <a name="input_environment"></a> [environment](#input\_environment)

Description: (Optional) The environment name for resource tagging and naming.

Type: `string`

Default: `"demo"`

### <a name="input_location"></a> [location](#input\_location)

Description: (Optional) The Azure region where resources will be deployed.

Type: `string`

Default: `"East US 2"`

### <a name="input_use_private_networking"></a> [use\_private\_networking](#input\_use\_private\_networking)

Description: (Optional) Whether to use private networking for the container registry. Set to false for local development.

Type: `bool`

Default: `false`

### <a name="input_virtual_network_address_space"></a> [virtual\_network\_address\_space](#input\_virtual\_network\_address\_space)

Description: (Optional) The address space for the virtual network in CIDR notation.

Type: `string`

Default: `"10.0.0.0/16"`

## Outputs

The following outputs are exported:

### <a name="output_azure_devops_agent_pool_id"></a> [azure\_devops\_agent\_pool\_id](#output\_azure\_devops\_agent\_pool\_id)

Description: The ID of the created Azure DevOps agent pool

### <a name="output_azure_devops_agent_pool_name"></a> [azure\_devops\_agent\_pool\_name](#output\_azure\_devops\_agent\_pool\_name)

Description: The name of the created Azure DevOps agent pool

### <a name="output_azure_devops_project_id"></a> [azure\_devops\_project\_id](#output\_azure\_devops\_project\_id)

Description: The ID of the created Azure DevOps project

### <a name="output_azure_devops_project_name"></a> [azure\_devops\_project\_name](#output\_azure\_devops\_project\_name)

Description: The name of the created Azure DevOps project

### <a name="output_azure_devops_project_url"></a> [azure\_devops\_project\_url](#output\_azure\_devops\_project\_url)

Description: The URL of the created Azure DevOps project

### <a name="output_azure_devops_service_connection_name"></a> [azure\_devops\_service\_connection\_name](#output\_azure\_devops\_service\_connection\_name)

Description: The name of the created Azure DevOps service connection

### <a name="output_container_app_environment_id"></a> [container\_app\_environment\_id](#output\_container\_app\_environment\_id)

Description: The resource ID of the Container App Environment from the AVM module

### <a name="output_container_app_environment_name"></a> [container\_app\_environment\_name](#output\_container\_app\_environment\_name)

Description: The name of the Container App Environment from the AVM module

### <a name="output_container_registry_id"></a> [container\_registry\_id](#output\_container\_registry\_id)

Description: The resource ID of the Container Registry from the AVM module

### <a name="output_container_registry_login_server"></a> [container\_registry\_login\_server](#output\_container\_registry\_login\_server)

Description: The login server URL of the Container Registry from the AVM module

### <a name="output_debug_info"></a> [debug\_info](#output\_debug\_info)

Description: Debug information for troubleshooting Azure AD integration

### <a name="output_getting_started_guide"></a> [getting\_started\_guide](#output\_getting\_started\_guide)

Description: Phase 1 setup summary and next steps

### <a name="output_resource_group_id"></a> [resource\_group\_id](#output\_resource\_group\_id)

Description: The ID of the resource group containing the infrastructure

### <a name="output_resource_group_location"></a> [resource\_group\_location](#output\_resource\_group\_location)

Description: The Azure region where the infrastructure is deployed

### <a name="output_resource_group_name"></a> [resource\_group\_name](#output\_resource\_group\_name)

Description: The name of the resource group containing the infrastructure

### <a name="output_user_assigned_managed_identity_client_id"></a> [user\_assigned\_managed\_identity\_client\_id](#output\_user\_assigned\_managed\_identity\_client\_id)

Description: The client ID of the created User Assigned Managed Identity

### <a name="output_user_assigned_managed_identity_id"></a> [user\_assigned\_managed\_identity\_id](#output\_user\_assigned\_managed\_identity\_id)

Description: The resource ID of the created User Assigned Managed Identity

### <a name="output_user_assigned_managed_identity_name"></a> [user\_assigned\_managed\_identity\_name](#output\_user\_assigned\_managed\_identity\_name)

Description: The name of the created User Assigned Managed Identity

### <a name="output_user_assigned_managed_identity_principal_id"></a> [user\_assigned\_managed\_identity\_principal\_id](#output\_user\_assigned\_managed\_identity\_principal\_id)

Description: The principal ID of the created User Assigned Managed Identity

### <a name="output_virtual_network_id"></a> [virtual\_network\_id](#output\_virtual\_network\_id)

Description: The resource ID of the Virtual Network from the AVM module

### <a name="output_virtual_network_name"></a> [virtual\_network\_name](#output\_virtual\_network\_name)

Description: The name of the Virtual Network from the AVM module

## Modules

The following Modules are called:

### <a name="module_azure_devops_agents"></a> [azure\_devops\_agents](#module\_azure\_devops\_agents)

Source: ../..

Version:

### <a name="module_naming"></a> [naming](#module\_naming)

Source: Azure/naming/azurerm

Version: >= 0.3.0

### <a name="module_uami"></a> [uami](#module\_uami)

Source: Azure/avm-res-managedidentity-userassignedidentity/azurerm

Version: 0.3.3

## Clean Up

To remove all resources created by this example:

```bash
terraform destroy
```

**Note**: This will remove:
- All Azure resources (Container Apps, UAMI, networking, etc.)
- Azure DevOps project and all associated resources
- Service connections and agent pools

## Next Steps

1. **Customize for Production**: Review security settings, network policies, and RBAC permissions
2. **Scale Configuration**: Adjust container scaling rules based on your workload
3. **Multi-Environment**: Use this pattern for dev/staging/prod environments
4. **Custom Agents**: Build custom container images with your required tools
5. **Monitoring**: Set up alerts and dashboards for agent performance

## Support

This example follows Azure Verified Modules (AVM) standards. For issues:
- **Module Issues**: [AVM Repository Issues](https://github.com/Azure/terraform-azurerm-avm-ptn-cicd-agents-and-runners/issues)
- **Azure DevOps Provider**: [Provider Documentation](https://registry.terraform.io/providers/microsoft/azuredevops/latest)
- **Azure Documentation**: [Container Apps](https://docs.microsoft.com/azure/container-apps/)

Remember to follow the [AVM Contributing Guidelines](https://azure.github.io/Azure-Verified-Modules/contributing/) when submitting improvements.
<!-- END_TF_DOCS -->